---
import Layout from '../../../../layouts/Layout.astro';
import BlogListSection from '../../../../components/sections/BlogListSection.astro';
import BlogHeroSection from '../../../../components/sections/BlogHeroSection.astro';
import { getCollection } from 'astro:content';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../../../consts';

export async function getStaticPaths() {
  const currentLang = 'de';

  // Get all blog posts for German
  const allPosts = await getCollection('blog');
  const posts = allPosts
    .filter(post => post.id.startsWith(`${currentLang}/`))
    .filter(post => !post.data.draft);

  // Get unique tags
  const tagsSet = new Set<string>();
  posts.forEach(post => {
    if (post.data.tags) {
      post.data.tags.forEach(tag => tagsSet.add(tag));
    }
  });

  // Create paths for each tag
  return Array.from(tagsSet).map(tag => ({
    params: {
      tag: tag.toLowerCase().replaceAll(/\s+/g, '-')
    },
    props: {
      tagName: tag,
      currentLang
    }
  }));
}

const { tag } = Astro.params;
const { tagName, currentLang } = Astro.props;
const pageSize = 10;

// Get all blog posts for German
const allPosts = await getCollection('blog');
const posts = allPosts
  .filter(post => post.id.startsWith(`${currentLang}/`))
  .filter(post => !post.data.draft)
  .filter(post => post.data.tags && post.data.tags.includes(tagName))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Get first page of posts
const firstPagePosts = posts.slice(0, pageSize);
const totalPages = Math.ceil(posts.length / pageSize);

// Create pagination object
const pagination = {
  currentPage: 1,
  lastPage: totalPages,
  url: {
    prev: undefined,
    next: totalPages > 1 ? `/de/blog/tag/${tag}/page/2` : undefined,
  },
};
---

<Layout title={`${SITE_TITLE} - #${tagName}`} description={SITE_DESCRIPTION}>
  <BlogHeroSection
    lang={currentLang}
    activeTag={tagName}
    filteredPostCount={posts.length}
  />

  <BlogListSection
    lang={currentLang}
    posts={firstPagePosts}
    pagination={totalPages > 1 ? pagination : undefined}
  />
</Layout>
