---
import { Quote, Star, User, ChevronLeft, ChevronRight, ArrowUpRight } from '@lucide/astro';

interface Props {
    lang: string;
}

const { lang } = Astro.props;

const translations = {
    en: {
        sectionTitle: "Trusted by Industry Leaders",
        subtitle: "Join thousands of teams who have transformed their workflows",
        testimonials: [
            {
                id: "1",
                quote: "This platform has completely revolutionized how our team collaborates. We've reduced project completion time by 60% and eliminated countless manual tasks.",
                author: "Sarah Chen",
                title: "VP of Operations",
                company: "TechForward Inc.",
                avatar: "/images/testimonials/sarah-chen.jpg",
                rating: 5,
                featured: true,
            },
            {
                id: "2",
                quote: "The automation capabilities are incredible. What used to take our team days now happens in minutes. The ROI was clear within the first month.",
                author: "Marcus Rodriguez",
                title: "Engineering Manager",
                company: "ScaleUp Solutions",
                avatar: "/images/testimonials/marcus-rodriguez.jpg",
                rating: 5,
                featured: true,
            },
            {
                id: "3",
                quote: "Outstanding support and incredibly intuitive interface. Our entire organization adopted it within weeks, and productivity has skyrocketed.",
                author: "Emily Watson",
                title: "Chief Technology Officer",
                company: "InnovateCorp",
                avatar: "/images/testimonials/emily-watson.jpg",
                rating: 5,
                featured: true,
            },
            {
                id: "4",
                quote: "The insights and analytics have given us visibility we never had before. Data-driven decisions have become the norm rather than the exception.",
                author: "David Kim",
                title: "Head of Product",
                company: "DataDriven LLC",
                avatar: "/images/testimonials/david-kim.jpg",
                rating: 5,
                featured: false,
            },
            {
                id: "5",
                quote: "Security, compliance, and ease of use - rarely do you find all three in one solution. This platform delivers on all fronts.",
                author: "Lisa Thompson",
                title: "Information Security Manager",
                company: "SecureFirst Bank",
                avatar: "/images/testimonials/lisa-thompson.jpg",
                rating: 5,
                featured: false,
            },
        ],
        stats: [
            { value: "10,000+", label: "Active Users" },
            { value: "500+", label: "Companies Trust Us" },
            { value: "99.9%", label: "Uptime Guarantee" },
            { value: "24/7", label: "Expert Support" },
        ],
        viewAllText: "View All Reviews",
        nextText: "Next testimonial",
        prevText: "Previous testimonial",
    },
    de: {
        sectionTitle: "Vertraut von Branchenführern",
        subtitle: "Schließen Sie sich Tausenden von Teams an, die ihre Arbeitsabläufe transformiert haben",
        testimonials: [
            {
                id: "1",
                quote: "Diese Plattform hat die Art, wie unser Team zusammenarbeitet, völlig revolutioniert. Wir haben die Projektabschlusszeit um 60% reduziert und unzählige manuelle Aufgaben eliminiert.",
                author: "Sarah Chen",
                title: "VP Operations",
                company: "TechForward Inc.",
                avatar: "/images/testimonials/sarah-chen.jpg",
                rating: 5,
                featured: true,
            },
            {
                id: "2",
                quote: "Die Automatisierungsfähigkeiten sind unglaublich. Was früher Tage gedauert hat, geschieht jetzt in Minuten. Der ROI war bereits im ersten Monat klar.",
                author: "Marcus Rodriguez",
                title: "Engineering Manager",
                company: "ScaleUp Solutions",
                avatar: "/images/testimonials/marcus-rodriguez.jpg",
                rating: 5,
                featured: true,
            },
            {
                id: "3",
                quote: "Hervorragender Support und unglaublich intuitive Benutzeroberfläche. Unsere gesamte Organisation hat es innerhalb von Wochen übernommen, und die Produktivität ist sprunghaft gestiegen.",
                author: "Emily Watson",
                title: "Chief Technology Officer",
                company: "InnovateCorp",
                avatar: "/images/testimonials/emily-watson.jpg",
                rating: 5,
                featured: true,
            },
            {
                id: "4",
                quote: "Die Einblicke und Analysen haben uns eine Sichtbarkeit gegeben, die wir nie zuvor hatten. Datengestützte Entscheidungen sind zur Regel geworden.",
                author: "David Kim",
                title: "Head of Product",
                company: "DataDriven LLC",
                avatar: "/images/testimonials/david-kim.jpg",
                rating: 5,
                featured: false,
            },
            {
                id: "5",
                quote: "Sicherheit, Compliance und Benutzerfreundlichkeit - selten findet man alle drei in einer Lösung. Diese Plattform liefert auf allen Fronten.",
                author: "Lisa Thompson",
                title: "Information Security Manager",
                company: "SecureFirst Bank",
                avatar: "/images/testimonials/lisa-thompson.jpg",
                rating: 5,
                featured: false,
            },
        ],
        stats: [
            { value: "10.000+", label: "Aktive Nutzer" },
            { value: "500+", label: "Unternehmen vertrauen uns" },
            { value: "99,9%", label: "Verfügbarkeitsgarantie" },
            { value: "24/7", label: "Experten-Support" },
        ],
        viewAllText: "Alle Bewertungen anzeigen",
        nextText: "Nächstes Testimonial",
        prevText: "Vorheriges Testimonial",
    },
};

import { useTranslations } from "../../utils/i18n";
const $t = useTranslations(translations, lang);
---

<section class="testimonials-section section" data-testimonials>
    <div class="container">
        <!-- Section Header -->
        <div class="section-header text-center">
            <h2 class="text-display-medium gradient-text">
                {$t("sectionTitle")}
            </h2>
            <p class="section-subtitle text-body-large">
                {$t("subtitle")}
            </p>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            {
                $t("stats").map((stat: any, index: number) => (
                    <div class="stat-item" data-stat-delay={index * 100}>
                        <div class="stat-value" data-stat-value={stat.value} data-counter>
                            {stat.value}
                        </div>
                        <div class="stat-label">{stat.label}</div>
                    </div>
                ))
            }
        </div>

        <!-- Testimonials Carousel -->
        <div class="embla" data-embla>
            <div class="embla__viewport">
                <div class="embla__container">
                    {
                        $t("testimonials").map((testimonial: any, index: number) => (
                            <div class="embla__slide">
                                <div class="testimonial-card">
                                    <div class="testimonial-content">
                                        <div class="quote-icon">
                                            <Quote size={32} />
                                        </div>

                                        <blockquote class="testimonial-quote text-body-large">
                                            "{testimonial.quote}"
                                        </blockquote>

                                        <div class="testimonial-rating">
                                            {Array.from({ length: testimonial.rating }, (_, i) => (
                                                <Star
                                                    key={i}
                                                    size={20}
                                                    fill="currentColor"
                                                />
                                            ))}
                                        </div>
                                    </div>

                                    <div class="testimonial-author">
                                        <div class="author-avatar">
                                            <div class="avatar-placeholder">
                                                <User size={40} />
                                            </div>
                                        </div>
                                        <div class="author-info">
                                            <div class="author-name text-heading-small">{testimonial.author}</div>
                                            <div class="author-title text-body-small">{testimonial.title}</div>
                                            <div class="author-company text-body-small">{testimonial.company}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))
                    }
                </div>
            </div>

            <!-- Embla Controls -->
            <div class="embla__controls">
                <div class="embla__buttons">
                    <button type="button" class="embla__button embla__button--prev" aria-label={$t("prevText")}>
                        <ChevronLeft class="embla__button__svg" />
                    </button>
                    <button type="button" class="embla__button embla__button--next" aria-label={$t("nextText")}>
                        <ChevronRight class="embla__button__svg" />
                    </button>
                </div>
            </div>
        </div>

        <!-- View All CTA -->
        <div class="section-cta text-center">
            <a href="#" class="btn btn-ghost">
                {$t("viewAllText")}
                <ArrowUpRight size={16} />
            </a>
        </div>
    </div>
</section>

<style>
    .testimonials-section {
        background: var(--color-background-primary);
        position: relative;
        overflow: hidden;
    }

    .section-header {
        margin-bottom: var(--space-12);
    }

    .section-subtitle {
        margin-top: var(--space-4);
        color: var(--color-text-secondary);
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
    }

    /* Statistics Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: var(--space-6);
        margin-bottom: var(--space-20);
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
    }

    .stat-item {
        text-align: center;
    }

    .stat-item.animate {
        opacity: 1;
        transform: translateY(0);
    }

    .stat-value {
        font-size: 36px;
        font-weight: 800;
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: var(--space-2);
        line-height: 1;
    }

    .stat-label {
        color: var(--color-text-secondary);
        font-size: 14px;
        font-weight: 500;
    }

    /* Embla Carousel */
    .embla {
        position: relative;
        margin-bottom: var(--space-16);
    }

    .embla__viewport {
        overflow: hidden;
        border-radius: var(--radius-xl);
    }

    .embla__container {
        display: flex;
        touch-action: pan-y pinch-zoom;
    }

    .embla__slide {
        flex: 0 0 100%;
        padding: 0 var(--space-2);
        min-width: 0;
    }

    .testimonial-card {
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-xl);
        padding: var(--space-10);
        position: relative;
        overflow: hidden;
        min-height: 400px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .testimonial-content {
        flex: 1;
    }

    .quote-icon {
        width: 48px;
        height: 48px;
        border-radius: var(--radius-lg);
        background: rgba(0, 102, 255, 0.1);
        color: var(--color-primary-blue);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: var(--space-6);
    }

    .testimonial-quote {
        color: var(--color-text-primary);
        font-style: italic;
        line-height: 1.6;
        margin-bottom: var(--space-6);
        font-size: 18px;
    }

    .testimonial-rating {
        display: flex;
        gap: var(--space-1);
        margin-bottom: var(--space-8);
        color: #facc15;
    }

    .testimonial-author {
        display: flex;
        align-items: center;
        gap: var(--space-4);
        padding-top: var(--space-6);
        border-top: 1px solid var(--color-border);
    }

    .author-avatar {
        flex-shrink: 0;
    }

    .avatar-placeholder {
        width: 64px;
        height: 64px;
        border-radius: var(--radius-full);
        background: var(--color-background-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--color-text-tertiary);
        border: 2px solid var(--color-border);
    }

    .author-info {
        flex: 1;
    }

    .author-name {
        color: var(--color-text-primary);
        font-weight: 600;
        margin-bottom: var(--space-1);
    }

    .author-title {
        color: var(--color-text-secondary);
        margin-bottom: var(--space-1);
    }

    .author-company {
        color: var(--color-text-tertiary);
        font-weight: 500;
    }

    /* Embla Controls */
    .embla__controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-6);
        margin-top: var(--space-8);
    }

    .embla__buttons {
        display: flex;
        align-items: center;
        gap: var(--space-4);
    }

    .embla__button {
        width: 48px;
        height: 48px;
        border-radius: var(--radius-full);
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        color: var(--color-text-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all var(--duration-fast) var(--ease-out);
        padding: 0;
        flex-shrink: 0;
        position: relative;
    }

    .embla__button:hover {
        background: var(--color-primary-blue);
        color: white;
        border-color: var(--color-primary-blue);
        transform: scale(1.05);
    }

    .embla__button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }

    .embla__button__svg {
        width: 20px;
        height: 20px;
        display: block;
        flex-shrink: 0;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    .embla__dots {
        display: flex;
        gap: var(--space-2);
        margin: 0 var(--space-4);
    }

    .embla__dot {
        width: 12px;
        height: 12px;
        border-radius: var(--radius-full);
        background: var(--color-border);
        border: none;
        cursor: pointer;
        transition: all var(--duration-fast) var(--ease-out);
        padding: 0;
    }

    .embla__dot--selected {
        background: var(--color-primary-blue);
        transform: scale(1.2);
    }

    .embla__dot:hover {
        background: var(--color-primary-hover);
    }

    /* Section CTA */
    .section-cta {
        margin-top: var(--space-16);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-6);
        }

        .testimonial-card {
            padding: var(--space-6);
            min-height: 350px;
        }

        .testimonial-quote {
            font-size: 16px;
        }

        .author-avatar .avatar-placeholder {
            width: 48px;
            height: 48px;
        }

        .embla__controls {
            gap: var(--space-4);
        }

        .embla__button {
            width: 40px;
            height: 40px;
        }

        .embla__button__svg {
            width: 16px;
            height: 16px;
        }

        .stat-value {
            font-size: 28px;
        }
    }

    /* Animations */
    @media (prefers-reduced-motion: reduce) {
        .carousel-track {
            transition: none;
        }

        .stat-item {
            opacity: 1 !important;
            transform: none !important;
        }
    }

    /* Fallback for no-JS environments */
    .no-js .stat-item {
        opacity: 1 !important;
        transform: none !important;
    }

    /* Ensure content becomes visible even if animations fail */
    .stat-item:not(.animate) {
        animation: fallback-reveal-stats 0.1s ease-out 2s forwards;
    }

    @keyframes fallback-reveal-stats {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<script>
    import EmblaCarousel from "embla-carousel";
    import Autoplay from "embla-carousel-autoplay";

    // Initialize testimonials animations immediately
    (function () {
        "use strict";

        function initTestimonialsAnimations() {
            // Animations now handled by GSAP ScrollTrigger through centralized animation system
            // Ensure content is visible for reduced motion preferences
            const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
            if (prefersReducedMotion) {
                const section = document.querySelector("[data-testimonials]");
                if (section) {
                    const statItems = section.querySelectorAll(".stat-item");
                    statItems.forEach((item) => {
                        item.style.opacity = "1";
                        item.style.transform = "none";
                    });
                }
            }
        }

        function initEmblaCarousel() {
            const emblaNode = document.querySelector("[data-embla]");
            if (!emblaNode) return;

            const viewport = emblaNode.querySelector(".embla__viewport");
            if (!viewport) return;

            // Initialize Embla
            const autoplayPlugin = Autoplay({ delay: 5000, stopOnInteraction: false });
            const embla = EmblaCarousel(
                viewport,
                {
                    loop: true,
                    align: "start",
                    skipSnaps: false,
                    dragFree: false,
                },
                [autoplayPlugin],
            );

            // Get control elements
            const prevBtn = emblaNode.querySelector(".embla__button--prev");
            const nextBtn = emblaNode.querySelector(".embla__button--next");
            const dotsContainer = emblaNode.querySelector(".embla__dots");

            // Setup navigation buttons
            if (prevBtn) {
                prevBtn.addEventListener("click", () => {
                    embla.scrollPrev();
                    autoplayPlugin.reset();
                });
            }

            if (nextBtn) {
                nextBtn.addEventListener("click", () => {
                    embla.scrollNext();
                    autoplayPlugin.reset();
                });
            }

            // Create dots
            if (dotsContainer) {
                const slides = embla.slideNodes();
                const dots = [];

                slides.forEach((_, index) => {
                    const dot = document.createElement("button");
                    dot.className = "embla__dot";
                    dot.type = "button";
                    dot.setAttribute("aria-label", `Go to slide ${index + 1}`);

                    dot.addEventListener("click", () => {
                        embla.scrollTo(index);
                        autoplayPlugin.reset();
                    });

                    dots.push(dot);
                    dotsContainer.appendChild(dot);
                });

                // Update dots on select
                const updateDots = () => {
                    const selectedIndex = embla.selectedScrollSnap();
                    dots.forEach((dot, index) => {
                        dot.classList.toggle("embla__dot--selected", index === selectedIndex);
                    });
                };

                embla.on("select", updateDots);
                updateDots(); // Initial state
            }

            // Update button states
            const updateButtons = () => {
                if (prevBtn) {
                    prevBtn.disabled = !embla.canScrollPrev();
                }
                if (nextBtn) {
                    nextBtn.disabled = !embla.canScrollNext();
                }
            };

            embla.on("select", updateButtons);
            updateButtons(); // Initial state

            // Pause autoplay on hover
            emblaNode.addEventListener("mouseenter", () => autoplayPlugin.stop());
            emblaNode.addEventListener("mouseleave", () => autoplayPlugin.play());

            return embla;
        }

        // Initialize when DOM is ready
        function init() {
            initTestimonialsAnimations();
            initEmblaCarousel();
        }

        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", init);
        } else {
            init();
        }

        // Also initialize on Astro page loads for SPA navigation
        document.addEventListener("astro:page-load", init);
    })();
</script>
