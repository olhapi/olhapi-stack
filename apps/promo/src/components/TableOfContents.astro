---
import { useTranslations } from '../utils/i18n';

interface Props {
  lang: string;
}

const { lang } = Astro.props;

const translations = {
  en: {
    title: 'Table of Contents',
  },
  de: {
    title: 'Inhaltsverzeichnis',
  },
};

const $t = useTranslations(translations, lang);
---

<aside class="toc-container">
  <div class="toc-sticky bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700">
    <h3 class="toc-title text-gray-600 dark:text-white">{$t('title')}</h3>
    <nav class="toc-nav" id="table-of-contents">
      <!-- Content will be generated by JavaScript -->
    </nav>
  </div>
</aside>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tocContainer = document.getElementById('table-of-contents');
    const article = document.querySelector('article .prose');

    if (!tocContainer || !article) return;

    // Find all headings in the article
    const headings = article.querySelectorAll('h1, h2, h3, h4, h5, h6');

    if (headings.length === 0) {
      const tocWrapper = document.querySelector('.toc-container');
      if (tocWrapper) tocWrapper.style.display = 'none';
      return;
    }

    // Generate table of contents
    const tocList = document.createElement('ul');
    tocList.className = 'toc-list';

    headings.forEach((heading, index) => {
      // Create an ID for the heading if it doesn't have one
      if (!heading.id) {
        heading.id = `heading-${index}`;
      }

      const level = parseInt(heading.tagName.charAt(1));
      const listItem = document.createElement('li');
      listItem.className = `toc-item toc-level-${level}`;

      const link = document.createElement('a');
      link.href = `#${heading.id}`;
      link.textContent = heading.textContent || '';
      link.className = 'toc-link';

      listItem.appendChild(link);
      tocList.appendChild(listItem);
    });

    tocContainer.appendChild(tocList);

    // Highlight active section on scroll
    function highlightActiveSection() {
      let activeHeading = null;
      const scrollPos = window.scrollY + 100; // Offset for header

      headings.forEach((heading) => {
        const rect = heading.getBoundingClientRect();
        const headingTop = rect.top + window.scrollY;

        if (headingTop <= scrollPos) {
          activeHeading = heading;
        }
      });

      // Remove previous active states
      tocContainer.querySelectorAll('.toc-link').forEach(link => {
        link.classList.remove('active');
      });

      // Add active state to current section
      if (activeHeading) {
        const activeLink = tocContainer.querySelector(`a[href="#${activeHeading.id}"]`);
        if (activeLink) {
          activeLink.classList.add('active');
        }
      }
    }

    // Smooth scroll to heading when clicking TOC links
    tocContainer.addEventListener('click', (e) => {
      if (e.target && e.target.classList.contains('toc-link')) {
        e.preventDefault();
        const targetId = e.target.getAttribute('href')?.substring(1);
        const targetHeading = document.getElementById(targetId);

        if (targetHeading) {
          const headerHeight = 80; // Adjust based on your header height
          const targetPosition = targetHeading.getBoundingClientRect().top + window.scrollY - headerHeight;

          window.scrollTo({
            top: targetPosition,
            behavior: 'smooth'
          });
        }
      }
    });

    // Listen for scroll events
    window.addEventListener('scroll', highlightActiveSection);
    highlightActiveSection(); // Initial call

    // Sticky TOC behavior with JavaScript (performance optimized)
    const tocContainerEl = document.querySelector('.toc-container');
    if (!tocContainerEl) return;

    let tocOriginalOffset = 0;
    let tocWidth = 0;
    let tocHeight = 0;
    let articleEndOffset = 0;
    let currentState = 'normal'; // 'normal' | 'fixed' | 'bottom'
    let rafId = null; // RequestAnimationFrame ID

    function calculateTocPosition() {
      if (window.innerWidth < 1024) return; // Only on desktop

      // Cache all measurements at once (batch read)
      const rect = tocContainerEl?.getBoundingClientRect();
    if (!rect) {
        return;
    }

      const articleEl = document.querySelector('article');

      tocOriginalOffset = rect.top + window.scrollY - 112; // 112px = 7rem header offset
      tocWidth = rect.width;
      tocHeight = rect.height;

      // Calculate where article content ends
      if (articleEl) {
        const articleRect = articleEl.getBoundingClientRect();
        articleEndOffset = articleRect.bottom + window.scrollY - 200; // 200px buffer before footer
      }
    }

    function handleTocScroll() {
      if (window.innerWidth < 1024) {
        // Reset on mobile
        if (currentState !== 'normal') {
          tocContainerEl.classList.remove('toc-fixed', 'toc-bottom');
          tocContainerEl.style.width = '';
          currentState = 'normal';
        }
        return;
      }

      // Throttle with requestAnimationFrame (max 60fps)
      if (rafId) return;

      rafId = requestAnimationFrame(() => {
        const scrollY = window.scrollY;
        const stopPoint = articleEndOffset - tocHeight;

        // Three-state logic
        if (scrollY <= tocOriginalOffset) {
          // State 1: Normal flow (before scroll threshold)
          if (currentState !== 'normal') {
            tocContainerEl.classList.remove('toc-fixed', 'toc-bottom');
            tocContainerEl.style.width = '';
            currentState = 'normal';
          }
        } else if (scrollY > tocOriginalOffset && scrollY < stopPoint) {
          // State 2: Fixed position (middle of article)
          if (currentState !== 'fixed') {
            tocContainerEl.classList.remove('toc-bottom');
            tocContainerEl.classList.add('toc-fixed');
            tocContainerEl.style.width = tocWidth + 'px';
            currentState = 'fixed';
          }
        } else if (scrollY >= stopPoint) {
          // State 3: Absolute at bottom (near article end)
          if (currentState !== 'bottom') {
            tocContainerEl.classList.remove('toc-fixed');
            tocContainerEl.classList.add('toc-bottom');
            tocContainerEl.style.width = tocWidth + 'px';
            currentState = 'bottom';
          }
        }

        rafId = null;
      });
    }

    // Initialize
    calculateTocPosition();
    handleTocScroll();

    // Optimized scroll listener
    window.addEventListener('scroll', handleTocScroll, { passive: true });

    // Debounced resize handler
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        calculateTocPosition();
        handleTocScroll();
      }, 150);
    });
  });
</script>

<style>
  .toc-container {
    display: none;
  }

  @media (min-width: 1024px) {
    .toc-container {
      display: block;
      transition: all 0.2s ease-in-out;
    }
  }

  /* Fixed positioning state (applied via JS) */
  .toc-container.toc-fixed {
    position: fixed;
    top: 6rem;
    z-index: 10;
    will-change: transform; /* GPU acceleration hint */
  }

  .toc-container.toc-fixed .toc-sticky {
    max-height: calc(100vh - 9rem);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  /* Bottom state - stops before footer (applied via JS) */
  .toc-container.toc-bottom {
    position: absolute;
    bottom: 0;
    z-index: 10;
  }

  .toc-container.toc-bottom .toc-sticky {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  .toc-sticky {
    overflow-y: auto;
    border-radius: 1rem;
    padding: 1rem;
    max-height: inherit;
  }

  .toc-title {
    font-size: 0.75rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  :global(.toc-list) {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  :global(.toc-item) {
    position: relative;
  }

  /* Base link styling - must come BEFORE level-specific overrides */
  :global(.toc-link) {
    display: block;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    font-weight: 400;
    color: rgb(107, 114, 128);
    text-decoration: none;
    border-radius: 0.375rem;
    transition: all 0.15s ease-in-out;
    line-height: 1.5;
    position: relative;
  }

  /* Level-specific indentation - overrides padding-left from base */
  :global(.toc-level-1 .toc-link) {
    padding-left: 0.75rem;
  }

  :global(.toc-level-2 .toc-link) {
    padding-left: 1.5rem;
  }

  :global(.toc-level-3 .toc-link) {
    padding-left: 2.25rem;
  }

  :global(.toc-level-4 .toc-link) {
    padding-left: 3rem;
  }

  :global(.toc-level-5 .toc-link) {
    padding-left: 3.75rem;
  }

  :global(.toc-level-6 .toc-link) {
    padding-left: 4.5rem;
  }

  /* Level-specific font sizes and weights for hierarchy */
  :global(.toc-level-1 .toc-link) {
    font-size: 0.875rem;
    font-weight: 500;
    color: rgb(75, 85, 99);
  }

  :global(.toc-level-2 .toc-link) {
    font-size: 0.8125rem;
    color: rgb(107, 114, 128);
  }

  :global(.toc-level-3 .toc-link),
  :global(.toc-level-4 .toc-link),
  :global(.toc-level-5 .toc-link),
  :global(.toc-level-6 .toc-link) {
    font-size: 0.8125rem;
    color: rgb(107, 114, 128);
  }

  :global(html[data-theme="dark"] .toc-level-1 .toc-link) {
    color: rgb(243, 244, 246);
  }

  :global(html[data-theme="dark"] .toc-level-2 .toc-link),
  :global(html[data-theme="dark"] .toc-level-3 .toc-link),
  :global(html[data-theme="dark"] .toc-level-4 .toc-link),
  :global(html[data-theme="dark"] .toc-level-5 .toc-link),
  :global(html[data-theme="dark"] .toc-level-6 .toc-link) {
    color: rgb(209, 213, 219);
  }

  :global(.toc-link:hover) {
    color: rgb(17, 24, 39);
    background-color: rgb(249, 250, 251);
  }

  :global(html[data-theme="dark"] .toc-link:hover) {
    color: rgb(229, 231, 235);
    background-color: rgb(55, 65, 81);
  }

  /* Active state with left accent bar */
  :global(.toc-link.active) {
    color: rgb(37, 99, 235);
    font-weight: 500;
    background-color: rgb(239, 246, 255);
  }

  :global(.toc-link.active::before) {
    content: '';
    position: absolute;
    left: 0.25rem;
    top: 50%;
    transform: translateY(-50%);
    width: 2px;
    height: 65%;
    background-color: rgb(37, 99, 235);
    border-radius: 2px;
  }

  :global(html[data-theme="dark"] .toc-link.active) {
    color: rgb(96, 165, 250);
    background-color: rgba(59, 130, 246, 0.1);
  }

  :global(html[data-theme="dark"] .toc-link.active::before) {
    background-color: rgb(96, 165, 250);
  }

  /* Modern minimal scrollbar */
  .toc-sticky::-webkit-scrollbar {
    width: 4px;
  }

  .toc-sticky::-webkit-scrollbar-track {
    background-color: transparent;
  }

  .toc-sticky::-webkit-scrollbar-thumb {
    background-color: rgb(209, 213, 219);
    border-radius: 9999px;
  }

  :global(html[data-theme="dark"]) .toc-sticky::-webkit-scrollbar-thumb {
    background-color: rgb(75, 85, 99);
  }

  .toc-sticky::-webkit-scrollbar-thumb:hover {
    background-color: rgb(156, 163, 175);
  }

  :global(html[data-theme="dark"]) .toc-sticky::-webkit-scrollbar-thumb:hover {
    background-color: rgb(107, 114, 128);
  }

  /* Smooth scroll behavior */
  .toc-sticky {
    scroll-behavior: smooth;
  }
</style>